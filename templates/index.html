<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Metrics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div>
        <h1 style="color: red;">SMA</h1>
        <div id="countdown-message"></div>
    </div>

    <div id="dashboard">
        
        <div class="section" id="cpu-section">
            <h2>CPU</h2>
            <div>Usage: <span id="cpu-usage">Loading...</span>%</div>
            <div>Physical Count: <span id="cpu-physical-count">Loading...</span></div>
            <div>Logical Count: <span id="cpu-logical-count">Loading...</span></div>
            <div>Speed: <span id="cpu-speed">Loading...</span> GHz</div>
            <div>Up-time: <span id="cpu-uptime">Loading...</span></div>
        </div>        
        <div class="section" id="memory-section">
            <h2>Memory</h2>
            <div>Total Available: <span id="total-memory">Loading...</span></div>
            <div>Used: <span id="used-memory">Loading...</span></div>
        </div>        
        <div class="section" id="disk-section">
            <h2>Disk</h2>
            <div id="disk-info">Loading...</div>
        </div>
        <div class="section" id="process-section">
            <h2>Process</h2>
            <div id="process-info">Loading...</div>
        </div>        
    </div>


    <script>
        let countdownInterval;
        let countdown = 30; // Initialize the countdown value
    
        function updateSystemMetrics() {
            fetch('/api/system_metrics') // Ensure this endpoint returns the expected JSON structure
                .then(response => response.json())
                .then(data => {
                    // CPU information updates
                    document.getElementById('cpu-usage').textContent = data.cpu_usage.percent.toFixed(1);
                    document.getElementById('cpu-physical-count').textContent = data.cpu_usage.physical_count;
                    document.getElementById('cpu-logical-count').textContent = data.cpu_usage.logical_count;
                    document.getElementById('cpu-speed').textContent = data.cpu_usage.speed + " GHz";
                    document.getElementById('cpu-uptime').textContent = data.cpu_usage.uptime;

                    // Memory information updates
                    document.getElementById('total-memory').textContent = data.memory_info.total + ' GB';
                    document.getElementById('used-memory').textContent = data.memory_info.used + ' GB';
                    //document.getElementById('memory-percent').textContent = data.memory_info.percent + '%';

                    // Disk information updates
                    const diskInfoElement = document.getElementById('disk-info');
                    diskInfoElement.innerHTML = ''; // Clear existing content
                    data.disk_info.forEach(disk => {
                        diskInfoElement.innerHTML += `<div>${disk.device} - Total: ${disk.total.toFixed(2)} GB, Used: ${disk.used.toFixed(2)} GB (${disk.percent}%)</div>`;
                    });

                    // Process information updates
                    const processInfoElement = document.getElementById('process-info');
                    processInfoElement.innerHTML = '<ul>'; // Start list
                    data.process_info.forEach(proc => {
                        processInfoElement.innerHTML += `<li>${proc.name} (PID: ${proc.pid}) - CPU: ${proc.cpu_percent}%, Memory: ${proc.memory_percent}%</li>`;
                    });
                    processInfoElement.innerHTML += '</ul>'; // Close list
                })
                .catch(error => console.error('Error fetching system metrics:', error));

            resetCountdown(); // Reset the countdown after updating metrics
        }

        
        function resetCountdown() {
            clearInterval(countdownInterval); // Clear any existing interval to avoid duplicates
            countdown = 30; // Reset the countdown
            updateCountdownMessage(); // Update the countdown message immediately
            
            countdownInterval = setInterval(() => {
                countdown--; // Decrement the countdown every second
                updateCountdownMessage();
    
                if (countdown <= 0) {
                    clearInterval(countdownInterval); // Clear the interval to stop the countdown
                    updateSystemMetrics(); // Fetch and update the system metrics, which will also reset the countdown
                }
            }, 1000); // Set to update every second
        }
    
        function updateCountdownMessage() {
            document.getElementById('countdown-message').textContent = `${countdown} seconds until refresh`;
        }
    
        // Initial call to update metrics and start the countdown
        updateSystemMetrics();
    </script>
    
</body>
</html>
